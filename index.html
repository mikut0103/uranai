<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âœˆï¸ tabisora - æ—…ã®ã—ãŠã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Zen+Maru+Gothic:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{--sky0:#0a1628;--sky1:#1a3a6b;--sky2:#2e6eb5;--sky3:#88c1e8;--accent:#ffdd57;--salmon:#ff7c5c;--mint:#7fffd4;--cream:#fffef8;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans JP',sans-serif;min-height:100vh;background:linear-gradient(180deg,var(--sky0) 0%,var(--sky1) 38%,var(--sky2) 68%,var(--sky3) 84%,#c8e8f8 94%,#e8f4fb 100%);overflow-x:hidden;}
#stars{position:fixed;top:0;left:0;right:0;height:55%;pointer-events:none;z-index:0;}
.star{position:absolute;background:white;border-radius:50%;animation:twinkle var(--d) var(--dl) infinite alternate;}
@keyframes twinkle{from{opacity:.1}to{opacity:1}}
#clouds{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
.cloud{position:absolute;background:white;border-radius:60px;animation:drift var(--d) var(--dl) linear infinite;}
@keyframes drift{from{transform:translateX(-300px)}to{transform:translateX(calc(100vw + 300px))}}
#plane{position:fixed;top:17%;font-size:2.4rem;z-index:5;pointer-events:none;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3));animation:planeFly 20s linear infinite,planeWobble 4s ease-in-out infinite;}
@keyframes planeFly{from{left:-100px}to{left:calc(100vw + 100px)}}
@keyframes planeWobble{0%,100%{transform:rotate(4deg) translateY(0)}50%{transform:rotate(-2deg) translateY(-12px)}}
#app{position:relative;z-index:10;max-width:480px;margin:0 auto;padding:0 16px 60px;}
.header{text-align:center;padding:64px 0 36px;animation:fadeUp .8s ease;}
.logo{font-family:'Pacifico',cursive;font-size:3rem;color:var(--accent);text-shadow:0 4px 20px rgba(255,221,87,.5),0 2px 4px rgba(0,0,0,.3);}
.tagline{color:rgba(255,255,255,.72);font-size:.8rem;letter-spacing:3px;text-transform:uppercase;margin-top:7px;}
.glass{background:rgba(255,255,255,.11);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);border:1px solid rgba(255,255,255,.28);border-radius:28px;padding:28px 22px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:fadeUp .8s ease .15s both;}
.card-title{text-align:center;color:white;font-family:'Zen Maru Gothic',sans-serif;font-weight:700;font-size:1.1rem;margin-bottom:24px;}
.field{margin-bottom:18px;}
.field label{display:block;color:rgba(255,255,255,.88);font-size:.74rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.field input,.field select,.field textarea{width:100%;border-radius:14px;padding:12px 15px;border:1.5px solid rgba(255,255,255,.22);background:rgba(255,255,255,.13);color:white;font-family:'Noto Sans JP',sans-serif;font-size:.93rem;outline:none;transition:border-color .25s,background .25s,box-shadow .25s;}
.field select{background:rgba(20,50,110,.85);cursor:pointer;}
.field textarea{resize:none;}
.field input::placeholder,.field textarea::placeholder{color:rgba(255,255,255,.35);}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);background:rgba(255,255,255,.2);box-shadow:0 0 20px rgba(255,221,87,.2);}
.pills{display:flex;flex-wrap:wrap;gap:7px;}
.pill{padding:7px 13px;border-radius:100px;border:1.5px solid rgba(255,255,255,.28);background:rgba(255,255,255,.1);color:rgba(255,255,255,.82);font-size:.79rem;cursor:pointer;transition:all .22s;user-select:none;font-family:'Noto Sans JP',sans-serif;}
.pill:hover{border-color:var(--accent);color:var(--accent);}
.pill.on{background:var(--accent);border-color:var(--accent);color:#1a3a6b;font-weight:700;box-shadow:0 4px 14px rgba(255,221,87,.42);}
.transports{display:flex;gap:8px;flex-wrap:wrap;}
.tp{flex:1;min-width:66px;text-align:center;padding:10px 6px;border-radius:14px;border:1.5px solid rgba(255,255,255,.26);background:rgba(255,255,255,.1);color:rgba(255,255,255,.82);font-size:.74rem;cursor:pointer;transition:all .22s;user-select:none;font-family:'Noto Sans JP',sans-serif;}
.tp .ic{font-size:1.4rem;display:block;margin-bottom:3px;}
.tp:hover{border-color:var(--mint);}
.tp.on{background:var(--mint);border-color:var(--mint);color:#083828;font-weight:700;box-shadow:0 4px 14px rgba(127,255,212,.32);}
.err{display:none;margin-top:12px;background:rgba(255,70,70,.18);border:1px solid rgba(255,70,70,.38);border-radius:13px;padding:11px 15px;color:#ffaaaa;font-size:.84rem;text-align:center;}
.err.show{display:block;}
.btn-submit{width:100%;margin-top:22px;padding:15px;border:none;border-radius:100px;background:linear-gradient(135deg,var(--accent),var(--salmon));color:#1a3a6b;font-family:'Zen Maru Gothic',sans-serif;font-weight:900;font-size:1.05rem;cursor:pointer;box-shadow:0 8px 28px rgba(255,221,87,.4);transition:transform .25s,box-shadow .25s;}
.btn-submit:hover{transform:translateY(-2px);box-shadow:0 14px 38px rgba(255,221,87,.58);}
#loading{display:none;text-align:center;padding:70px 0;}
#loading.show{display:block;}
.plane-bounce{font-size:3.5rem;display:inline-block;animation:bounce 1.6s ease-in-out infinite;}
@keyframes bounce{0%,100%{transform:translateY(0) rotate(4deg)}50%{transform:translateY(-20px) rotate(-3deg)}}
.loading-txt{color:rgba(255,255,255,.82);font-size:.95rem;margin-top:20px;animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:.45}50%{opacity:1}}
#shiori{display:none;}
#shiori.show{display:block;animation:fadeUp .8s ease;}
.s-cover{background:linear-gradient(145deg,#fff9e8,#ffe8d6);border-radius:26px 26px 0 0;padding:30px 22px 22px;text-align:center;box-shadow:0 -4px 24px rgba(0,0,0,.1);}
.s-cover-title{font-family:'Pacifico',cursive;font-size:1.75rem;color:var(--salmon);margin-bottom:4px;}
.s-cover-sub{font-size:.7rem;color:#b09080;letter-spacing:3px;text-transform:uppercase;}
.s-emoji{font-size:2rem;margin:14px 0 6px;}
.s-dest{font-family:'Zen Maru Gothic',sans-serif;font-size:1.5rem;font-weight:900;color:#3a1a0a;}
.s-copy{font-size:.82rem;color:#8a6050;margin-top:5px;font-style:italic;}
.s-badges{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-top:14px;}
.badge{background:rgba(255,107,157,.1);border:1px solid rgba(255,107,157,.28);border-radius:100px;padding:4px 11px;font-size:.72rem;color:#c05080;font-weight:700;}
.badge.theme{background:rgba(255,221,87,.13);border-color:rgba(210,150,0,.28);color:#a07010;}
.s-body{background:var(--cream);padding:20px 18px 30px;border-radius:0 0 26px 26px;box-shadow:0 20px 55px rgba(0,0,0,.14);}
.day-block{margin-bottom:22px;}
.day-head{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.day-label{color:white;font-family:'Zen Maru Gothic',sans-serif;font-weight:900;font-size:.72rem;padding:4px 12px;border-radius:100px;white-space:nowrap;}
.day-ttl{font-family:'Zen Maru Gothic',sans-serif;font-weight:700;font-size:.95rem;color:#2a1a0a;}
.timeline{position:relative;padding-left:20px;}
.timeline::before{content:'';position:absolute;left:6px;top:0;bottom:0;width:2px;border-radius:2px;}
.tl-item{position:relative;margin-bottom:13px;}
.tl-dot{position:absolute;left:-17px;top:7px;width:10px;height:10px;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,.15);}
.tl-time{font-size:.7rem;font-weight:700;letter-spacing:1px;margin-bottom:3px;}
.act-card{border-radius:13px;padding:11px 13px;box-shadow:0 3px 14px rgba(0,0,0,.07);border-left:3px solid;transition:transform .2s,box-shadow .2s;cursor:default;}
.act-card:hover{transform:translateX(4px);box-shadow:0 6px 22px rgba(0,0,0,.1);}
.act-name{font-family:'Zen Maru Gothic',sans-serif;font-weight:700;font-size:.9rem;color:#2a1a0a;margin-bottom:3px;}
.act-desc{font-size:.77rem;color:#7a6a5a;line-height:1.55;}
.act-tags{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap;}
.act-tag{font-size:.64rem;padding:2px 8px;border-radius:100px;font-weight:700;border:1px solid;}
.divider{text-align:center;font-size:1.1rem;margin:14px 0;opacity:.4;}
.tips-box{background:linear-gradient(135deg,#e8f4ff,#f0e8ff);border-radius:17px;padding:17px;margin-top:8px;border:1px dashed rgba(130,80,200,.28);}
.tips-title{font-family:'Zen Maru Gothic',sans-serif;font-weight:700;font-size:.86rem;color:#6040b0;margin-bottom:10px;}
.tip-row{font-size:.78rem;color:#5a4a7a;padding:6px 0;border-bottom:1px dashed rgba(130,80,200,.18);line-height:1.55;}
.tip-row:last-child{border-bottom:none;}
.s-footer{text-align:center;margin-top:24px;font-size:1.5rem;}
.s-credit{text-align:center;color:#ccc;font-size:.68rem;margin-top:8px;}
.btn-back{display:block;width:100%;margin-top:18px;padding:14px;border:2px solid rgba(255,255,255,.44);border-radius:100px;background:transparent;color:white;font-family:'Zen Maru Gothic',sans-serif;font-weight:700;font-size:.9rem;cursor:pointer;transition:background .25s;}
.btn-back:hover{background:rgba(255,255,255,.14);}
@keyframes fadeUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div id="stars"></div>
<div id="clouds"></div>
<div id="plane">âœˆï¸</div>
<div id="app">
  <div class="header">
    <div class="logo">tabisora</div>
    <div class="tagline">âœ¨ æ—…ã®ã—ãŠã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ âœ¨</div>
  </div>
  <div class="glass" id="formCard">
    <div class="card-title">ğŸ—ºï¸ æ—…ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã­</div>
    <div class="field">
      <label>ğŸ“ å‡ºç™ºåœ°</label>
      <input id="f-dep" type="text" placeholder="ä¾‹ï¼šæ±äº¬ã€å¤§é˜ªã€ç¦å²¡...">
    </div>
    <div class="field">
      <label>ğŸ—“ï¸ æ—…ã®æœŸé–“</label>
      <select id="f-dur">
        <option value="">é¸ã‚“ã§ã­</option>
        <option>æ—¥å¸°ã‚Šï¼ˆ0æ³Š1æ—¥ï¼‰</option>
        <option>1æ³Š2æ—¥</option>
        <option>2æ³Š3æ—¥</option>
        <option>3æ³Š4æ—¥</option>
        <option>4æ³Š5æ—¥</option>
        <option>ç´„1é€±é–“ï¼ˆ6ã€œ7æ—¥ï¼‰</option>
      </select>
    </div>
    <div class="field">
      <label>ğŸ¨ æ—…ã®ãƒ†ãƒ¼ãƒï¼ˆè¤‡æ•°OKï¼‰</label>
      <div class="pills" id="themePills">
        <div class="pill" data-v="ã‚°ãƒ«ãƒ¡">ğŸœ ã‚°ãƒ«ãƒ¡</div>
        <div class="pill" data-v="è‡ªç„¶ãƒ»çµ¶æ™¯">ğŸŒ„ è‡ªç„¶ãƒ»çµ¶æ™¯</div>
        <div class="pill" data-v="ã‚«ãƒ•ã‚§å·¡ã‚Š">â˜• ã‚«ãƒ•ã‚§å·¡ã‚Š</div>
        <div class="pill" data-v="æ­´å²ãƒ»æ–‡åŒ–">â›©ï¸ æ­´å²ãƒ»æ–‡åŒ–</div>
        <div class="pill" data-v="ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ">ğŸ“¸ ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ</div>
        <div class="pill" data-v="æ¸©æ³‰ãƒ»ç™’ã—">â™¨ï¸ æ¸©æ³‰ãƒ»ç™’ã—</div>
        <div class="pill" data-v="ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£">ğŸ„ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
        <div class="pill" data-v="ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°">ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</div>
        <div class="pill" data-v="ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒƒãƒ—ã‚«ãƒ«ãƒãƒ£ãƒ¼">ğŸŒ ã‚¢ãƒ‹ãƒ¡</div>
        <div class="pill" data-v="å¤œæ™¯ãƒ»ãƒãƒ¼">ğŸŒƒ å¤œæ™¯ãƒ»ãƒãƒ¼</div>
      </div>
    </div>
    <div class="field">
      <label>ğŸš— ç§»å‹•æ–¹æ³•</label>
      <div class="transports" id="transPills">
        <div class="tp" data-v="âœˆï¸ é£›è¡Œæ©Ÿ"><span class="ic">âœˆï¸</span>é£›è¡Œæ©Ÿ</div>
        <div class="tp" data-v="ğŸš„ æ–°å¹¹ç·š"><span class="ic">ğŸš„</span>æ–°å¹¹ç·š</div>
        <div class="tp" data-v="ğŸš— ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼"><span class="ic">ğŸš—</span>ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼</div>
        <div class="tp" data-v="ğŸšŒ ãƒã‚¹"><span class="ic">ğŸšŒ</span>ãƒã‚¹</div>
        <div class="tp" data-v="ğŸš¢ ãƒ•ã‚§ãƒªãƒ¼"><span class="ic">ğŸš¢</span>ãƒ•ã‚§ãƒªãƒ¼</div>
      </div>
    </div>
    <div class="field">
      <label>ğŸŒ è¡Œãå…ˆï¼ˆä»»æ„ï¼‰</label>
      <input id="f-dest" type="text" placeholder="ä¾‹ï¼šäº¬éƒ½ã€åŒ—æµ·é“ã€æ²–ç¸„ã€å°æ¹¾...">
    </div>
    <div class="field">
      <label>ğŸ’¬ ã²ã¨ã“ã¨å¸Œæœ›ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="f-memo" rows="2" placeholder="ä¾‹ï¼šå¥³å­æ—…2äººã€äºˆç®—1æ—¥1ä¸‡å††ã€è‡ªç„¶ãŒå¥½ã..."></textarea>
    </div>
    <div class="err" id="errMsg"></div>
    <button class="btn-submit" onclick="onSubmit()">âœˆï¸ ã—ãŠã‚Šã‚’ä½œã‚‹ï¼</button>
  </div>
  <div id="loading">
    <div class="plane-bounce">âœˆï¸</div>
    <div class="loading-txt" id="loadTxt">æ—…ã®ã—ãŠã‚Šã‚’ä½œæˆä¸­...</div>
  </div>
  <div id="shiori">
    <div id="shioriContent"></div>
    <button class="btn-back" onclick="goBack()">â† ã‚‚ã†ä¸€åº¦ä½œã‚‹</button>
  </div>
</div>

<script>
// ====================================================
// ğŸ”‘ APIã‚­ãƒ¼ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
const API_KEY = 'sk-ant-xxxxxxxxxxxxxxxxxx';
// ====================================================

/* Stars */
const starsEl=document.getElementById('stars');
for(let i=0;i<75;i++){const s=document.createElement('div');s.className='star';const sz=Math.random()*2.5+1;s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;width:${sz}px;height:${sz}px;--d:${2+Math.random()*3}s;--dl:${Math.random()*4}s`;starsEl.appendChild(s);}

/* Clouds */
const cloudsEl=document.getElementById('clouds');
[[130,42,'13%','26s','0s',.5],[185,56,'55%','37s','-9s',.62],[90,30,'33%','21s','-5s',.38],[155,48,'73%','41s','-17s',.68]].forEach(([w,h,t,d,dl,o])=>{const c=document.createElement('div');c.className='cloud';c.style.cssText=`width:${w}px;height:${h}px;top:${t};opacity:${o};--d:${d};--dl:${dl}`;cloudsEl.appendChild(c);});

/* Pills */
document.querySelectorAll('.pill').forEach(p=>p.onclick=()=>p.classList.toggle('on'));
document.querySelectorAll('.tp').forEach(p=>p.onclick=()=>{document.querySelectorAll('.tp').forEach(x=>x.classList.remove('on'));p.classList.add('on');});

/* Loading msgs */
const MSGS=['æ—…ã®ã—ãŠã‚Šã‚’ä½œæˆä¸­...','âœ¨ ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆæ¢ã—ã¦ã‚‹ã‚ˆ...','ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’è€ƒãˆã¦ã‚‹ã‚ˆ...','ğŸŒŸ ã‚‚ã†ã™ãå‡ºç™ºï¼'];
let midx=0,mtimer=null;
function startMsgs(){midx=0;document.getElementById('loadTxt').textContent=MSGS[0];mtimer=setInterval(()=>{midx=(midx+1)%MSGS.length;document.getElementById('loadTxt').textContent=MSGS[midx];},1800);}
function stopMsgs(){clearInterval(mtimer);}

const COLORS=[{b:'#ff7c5c',bg:'#fff5f2'},{b:'#ff9a5c',bg:'#fff8f0'},{b:'#ffb347',bg:'#fffbf0'},{b:'#ff6b9d',bg:'#fff0f6'},{b:'#9b59b6',bg:'#f8f0ff'},{b:'#3498db',bg:'#f0f8ff'},{b:'#2ecc71',bg:'#f0fff4'}];

/* ===== ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ ===== */
const SPOT_DB = {
  ã‚°ãƒ«ãƒ¡:{
    am:['åœ°å…ƒã®æœå¸‚ã§ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°','è€èˆ—å–«èŒ¶ã§ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°','åœ°å…ƒã‚¹ãƒ¼ãƒ‘ãƒ¼ã§æœé£Ÿæ¢ç´¢'],
    mid:['åç‰©ãƒ©ãƒ³ãƒ','æœ‰åãƒ©ãƒ¼ãƒ¡ãƒ³åº—','åœ°å…ƒã®å®šé£Ÿå±‹','åç‰©ä¸¼ãƒ©ãƒ³ãƒ'],
    pm:['åœ°å…ƒå±…é…’å±‹ã§å¤•é£Ÿ','äººæ°—ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§ãƒ‡ã‚£ãƒŠãƒ¼','å±‹å°è¡—ã‚’é£Ÿã¹æ­©ã'],
    spot:['å¸‚å ´','ãƒ•ãƒ¼ãƒ‰ãƒ›ãƒ¼ãƒ«','åœ°å…ƒã®ååº—']
  },
  'è‡ªç„¶ãƒ»çµ¶æ™¯':{
    am:['æ—©æœã®å±•æœ›å°ã§çµ¶æ™¯','æœéœ§ã®ä¸­ã‚’ãƒã‚¤ã‚­ãƒ³ã‚°','æ—¥ã®å‡ºã‚¹ãƒãƒƒãƒˆã¸'],
    mid:['çµ¶æ™¯ã‚«ãƒ•ã‚§ã§ãƒ©ãƒ³ãƒ','è‡ªç„¶å…¬åœ’ã‚’ãƒˆãƒ¬ãƒƒã‚­ãƒ³ã‚°','æ¹–ç•”ã§ãƒ”ã‚¯ãƒ‹ãƒƒã‚¯'],
    pm:['å¤•æ—¥ã®åæ‰€ã¸','æ˜Ÿç©ºè¦³å¯Ÿ','ãƒŠã‚¤ãƒˆãƒã‚¤ã‚¯'],
    spot:['å±•æœ›å°','å›½ç«‹å…¬åœ’','æ¹–','æ»','å±±é ‚']
  },
  'ã‚«ãƒ•ã‚§å·¡ã‚Š':{
    am:['ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚«ãƒ•ã‚§ã§æœé£Ÿ','æœ‰åãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚«ãƒ•ã‚§','éš ã‚Œå®¶ã‚«ãƒ•ã‚§ã§ã‚†ã£ãŸã‚Š'],
    mid:['è©±é¡Œã®ãƒ©ãƒ³ãƒã‚«ãƒ•ã‚§','ãƒãƒ³ãƒ‰ãƒ‰ãƒªãƒƒãƒ—å°‚é–€åº—','ãƒ–ãƒƒã‚¯ã‚«ãƒ•ã‚§ã§ã¾ã£ãŸã‚Š'],
    pm:['å¤œã‚«ãƒ•ã‚§ã§ã‚¹ã‚¤ãƒ¼ãƒ„','ãƒãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ã‚ã‚‹ cafe','ã€†ã®ã‚³ãƒ¼ãƒ’ãƒ¼ã‚·ãƒ§ãƒƒãƒ—'],
    spot:['ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ†ã‚£ã‚³ãƒ¼ãƒ’ãƒ¼åº—','å¤æ°‘å®¶ã‚«ãƒ•ã‚§','çµ¶æ™¯ã‚«ãƒ•ã‚§','çŒ«ã‚«ãƒ•ã‚§']
  },
  'æ­´å²ãƒ»æ–‡åŒ–':{
    am:['æ­´å²çš„ç¥ç¤¾ãƒ»ä»é–£ã‚’å‚æ‹','æ—©æœã®é™ã‹ãªåŸå€æ•£ç­–','åšç‰©é¤¨ã®ã‚ªãƒ¼ãƒ—ãƒ³æ™‚é–“ã«åˆã‚ã›ã¦'],
    mid:['æ­´å²çš„ç”ºä¸¦ã¿ã‚’æ•£ç­–','ä¼çµ±å·¥èŠ¸ä½“é¨“','éƒ·åœŸæ–™ç†ãƒ©ãƒ³ãƒ'],
    pm:['å¤œã®æ–‡åŒ–æ–½è¨­','ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—ã•ã‚ŒãŸåæ‰€','ä¼çµ±èŠ¸èƒ½é‘‘è³'],
    spot:['ç¥ç¤¾','å¯º','åŸè·¡','åšç‰©é¤¨','ä¼çµ±çš„è¡—ä¸¦ã¿']
  },
  'ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ':{
    am:['æ˜ ãˆã‚¹ãƒãƒƒãƒˆã§æœã®æ’®å½±','ãƒ•ã‚©ãƒˆã‚¸ã‚§ãƒ‹ãƒƒã‚¯ãªãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°','ã‚¢ãƒ¼ãƒˆã‚¹ãƒãƒƒãƒˆå·¡ã‚Š'],
    mid:['ã‚«ãƒ©ãƒ•ãƒ«ãªãƒ©ãƒ³ãƒ','ãƒ•ã‚©ãƒˆã‚¹ãƒãƒƒãƒˆå·¡ã‚Š','ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆã‚«ãƒ•ã‚§'],
    pm:['å¤•æš®ã‚Œã®çµ¶æ™¯ã‚·ãƒ§ãƒƒãƒˆ','ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—æ’®å½±','å¤œæ™¯ãƒ•ã‚©ãƒˆã‚¹ãƒãƒƒãƒˆ'],
    spot:['å£ç”»ã‚¢ãƒ¼ãƒˆ','æ˜ ãˆã‚«ãƒ•ã‚§','å±•æœ›ã‚¹ãƒãƒƒãƒˆ','ãƒ•ã‚©ãƒˆã‚¹ãƒãƒƒãƒˆ']
  },
  'æ¸©æ³‰ãƒ»ç™’ã—':{
    am:['æœé¢¨å‘‚ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥','æ¸©æ³‰è¡—ã‚’æœæ•£æ­©','æ—…é¤¨ã®æœé£Ÿã‚’ã‚†ã£ãã‚Š'],
    mid:['æ—¥å¸°ã‚Šæ¸©æ³‰ã§ã®ã‚“ã³ã‚Š','è¶³æ¹¯ã‚«ãƒ•ã‚§','æ¸©æ³‰ã¾ã‚“ã˜ã‚…ã†é£Ÿã¹æ­©ã'],
    pm:['å¤œã®éœ²å¤©é¢¨å‘‚','æ¸©æ³‰è¡—ã®å¤œæ•£æ­©','æ—…é¤¨ã§ãŠéƒ¨å±‹é£Ÿ'],
    spot:['éœ²å¤©é¢¨å‘‚','è¶³æ¹¯','æ¸©æ³‰è¡—','æ¹¯æ²»å ´']
  },
  'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£':{
    am:['æœã®ã‚µãƒ¼ãƒ•ã‚£ãƒ³ä½“é¨“','ã‚«ãƒ¤ãƒƒã‚¯ä½“é¨“','ãƒã‚¤ã‚­ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆ'],
    mid:['ãƒãƒªãƒ³ã‚¹ãƒãƒ¼ãƒ„ä½“é¨“','ã‚¸ãƒƒãƒ—ãƒ©ã‚¤ãƒ³','ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°'],
    pm:['å¤•æ–¹ã®ãƒœãƒ¼ãƒˆã‚¯ãƒ«ãƒ¼ã‚º','ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ‘ãƒ¼ã‚¯','å¤œã®ãƒŠã‚¤ãƒˆã‚µãƒ•ã‚¡ãƒª'],
    spot:['ãƒãƒªãƒ¼ãƒŠ','ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ãƒ‘ãƒ¼ã‚¯','ä½“é¨“æ–½è¨­','ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰']
  },
  'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°':{
    am:['å•†åº—è¡—ã‚’ã¶ã‚‰ã‚Šæœæ•£æ­©','éª¨è‘£å¸‚ãƒ»ãƒ•ãƒªãƒ','åœ°å…ƒã®ãƒ‘ãƒ³å±‹å·¡ã‚Š'],
    mid:['ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«','åœ°å…ƒã®ãƒãƒ¼ã‚±ãƒƒãƒˆ','ã‚¢ãƒ¼ã‚±ãƒ¼ãƒ‰è¡—'],
    pm:['å¤œã®ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°','ãƒŠã‚¤ãƒˆãƒãƒ¼ã‚±ãƒƒãƒˆ','ãŠåœŸç”£æ¢ã—'],
    spot:['å•†åº—è¡—','ã‚¢ã‚¦ãƒˆãƒ¬ãƒƒãƒˆ','ãƒãƒ¼ã‚±ãƒƒãƒˆ','ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—']
  },
  'ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒƒãƒ—ã‚«ãƒ«ãƒãƒ£ãƒ¼':{
    am:['è–åœ°å·¡ç¤¼ã‚¹ã‚¿ãƒ¼ãƒˆ','ã‚¢ãƒ‹ãƒ¡ã‚·ãƒ§ãƒƒãƒ—ã‚ªãƒ¼ãƒ—ãƒ³å¾…ã¡','ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ•ã‚§ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°'],
    mid:['ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£å·¡ã‚Š','ã‚¢ãƒ‹ãƒ¡é–¢é€£ã‚¹ãƒãƒƒãƒˆ','ã‚³ã‚¹ãƒ—ãƒ¬ã‚·ãƒ§ãƒƒãƒ—'],
    pm:['ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼','ã‚¢ãƒ‹ãƒ¡ã‚¤ãƒ™ãƒ³ãƒˆ','å¤œã®ç§‹è‘‰åŸçš„ã‚¨ãƒªã‚¢'],
    spot:['ã‚¢ãƒ‹ãƒ¡ã‚·ãƒ§ãƒƒãƒ—','è–åœ°','ã‚­ãƒ£ãƒ©ã‚«ãƒ•ã‚§','ã‚²ãƒ¼ã‚»ãƒ³']
  },
  'å¤œæ™¯ãƒ»ãƒãƒ¼':{
    am:['ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å¾Œã«è¦³å…‰','æ˜¼é–“ã®ã†ã¡ã«å®šç•ªã‚¹ãƒãƒƒãƒˆ','å¤•æ–¹ã«å‘ã‘ã¦ã®ã‚“ã³ã‚Š'],
    mid:['å¤•é£Ÿã‚’æ—©ã‚ã«','å±•æœ›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§ãƒ‡ã‚£ãƒŠãƒ¼','å¤œæ™¯ãŒè¦‹ãˆã‚‹ã‚«ãƒ•ã‚§'],
    pm:['å¤œæ™¯ã‚¹ãƒãƒƒãƒˆã¸','ãŠã—ã‚ƒã‚Œãªãƒãƒ¼ã§ä¸€æ¯','å±‹ä¸Šãƒãƒ¼ã§ä¹¾æ¯'],
    spot:['å±•æœ›å°','ã‚¹ã‚«ã‚¤ãƒãƒ¼','å¤œæ™¯ã‚¹ãƒãƒƒãƒˆ','ãƒ«ãƒ¼ãƒ•ãƒˆãƒƒãƒ—ãƒãƒ¼']
  }
};

const DEST_SUGGEST = {
  'æ±äº¬': ['æµ…è‰ãƒ»ä¸Šé‡','æ–°å®¿ãƒ»æ¸‹è°·','ãŠå°å ´ãƒ»è±Šæ´²','éŠ€åº§ãƒ»æ—¥æœ¬æ©‹','ä¸‹åŒ—æ²¢ãƒ»ä¸­ç›®é»’'],
  'å¤§é˜ª': ['é“é “å €ãƒ»å¿ƒæ–æ©‹','æ¢…ç”°ãƒ»åŒ—æµœ','å¤©æº€ãƒ»ä¸­å´ç”º','æ–°ä¸–ç•Œãƒ»é›£æ³¢'],
  'äº¬éƒ½': ['åµå±±','æ¸…æ°´å¯ºãƒ»ç¥‡åœ’','ä¼è¦‹ç¨²è·','åµ¯å³¨é‡','é‡‘é–£å¯ºã‚¨ãƒªã‚¢'],
  'åŒ—æµ·é“': ['æœ­å¹Œ','å‡½é¤¨','å¯Œè‰¯é‡','å°æ¨½','çŸ¥åºŠ'],
  'æ²–ç¸„': ['é‚£è¦‡ãƒ»å›½éš›é€šã‚Š','ç¾ã‚‰æµ·æ°´æ—é¤¨ã‚¨ãƒªã‚¢','å®®å¤å³¶','çŸ³å£å³¶','æ©ç´æ‘'],
  'ç¦å²¡': ['åšå¤š','å¤©ç¥','æŸ³å·','ç³¸å³¶','å¤ªå®°åºœ'],
};

function pickRand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function buildPlan(dep, dur, themes, trans, dest, memo){
  // æ—¥æ•°
  const dayMap = {'æ—¥å¸°ã‚Šï¼ˆ0æ³Š1æ—¥ï¼‰':1,'1æ³Š2æ—¥':2,'2æ³Š3æ—¥':3,'3æ³Š4æ—¥':4,'4æ³Š5æ—¥':5,'ç´„1é€±é–“ï¼ˆ6ã€œ7æ—¥ï¼‰':7};
  const numDays = dayMap[dur] || 2;

  // ç›®çš„åœ°
  let destination = dest;
  if(!destination){
    const keys = Object.keys(DEST_SUGGEST);
    const matched = keys.find(k=>dep.includes(k));
    if(matched){
      const opts = keys.filter(k=>k!==matched);
      destination = pickRand(opts);
    } else {
      destination = pickRand(['äº¬éƒ½','åŒ—æµ·é“','æ²–ç¸„','ç¦å²¡','å¥ˆè‰¯','é‡‘æ²¢','é•·å´','ä»™å°','åºƒå³¶','éŒå€‰']);
    }
  }

  // ãƒ†ãƒ¼ãƒåˆ¥ã‚¹ãƒãƒƒãƒˆDBå–å¾—
  const themeData = themes.map(t => SPOT_DB[t] || SPOT_DB['ã‚°ãƒ«ãƒ¡']);

  // emoji & catchcopy
  const emojiMap = {'ã‚°ãƒ«ãƒ¡':'ğŸœ','è‡ªç„¶ãƒ»çµ¶æ™¯':'ğŸŒ„','ã‚«ãƒ•ã‚§å·¡ã‚Š':'â˜•','æ­´å²ãƒ»æ–‡åŒ–':'â›©ï¸','ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ':'ğŸ“¸','æ¸©æ³‰ãƒ»ç™’ã—':'â™¨ï¸','ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£':'ğŸ„','ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°':'ğŸ›ï¸','ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒƒãƒ—ã‚«ãƒ«ãƒãƒ£ãƒ¼':'ğŸŒ','å¤œæ™¯ãƒ»ãƒãƒ¼':'ğŸŒƒ'};
  const emojis = ['âœˆï¸', ...themes.slice(0,3).map(t=>emojiMap[t]||'ğŸŒŸ')].join('');

  const copies = [
    `${destination}ã§æœ€é«˜ã®æ€ã„å‡ºã‚’`,`${destination}ã€å…¨åŠ›ã§æ¥½ã—ã‚‚ã†ï¼`,
    `å¿ƒãŒèºã‚‹${destination}ã®æ—…`,`å¿˜ã‚Œã‚‰ã‚Œãªã„${destination}ã¸`,
    `${destination}ã§è‡ªåˆ†ã ã‘ã®æ—…ã‚’`
  ];

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ
  const dayTitles = [
    ['å‡ºç™ºï¼ã¾ãšã¯å®šç•ªã‚¹ãƒãƒƒãƒˆã¸','æœã‹ã‚‰å…¨åŠ›ã§æ¥½ã—ã‚€æ—¥','ãƒ†ãƒ¼ãƒã‚’æ·±æ˜ã‚Šã™ã‚‹æ—¥'],
    ['åœ°å…ƒã®é­…åŠ›ã‚’å†ç™ºè¦‹','ã®ã‚“ã³ã‚Šæ´¾? ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ´¾?','æ—…ã®é†é†å‘³ã€å…¨éƒ¨è©°ã‚è¾¼ã‚€'],
    ['æœ€çµ‚æ—¥ã¯æ€ã„å‡ºãƒ©ãƒƒã‚·ãƒ¥','å¸°ã‚‹å‰ã«ã‚‚ã†ä¸€ã‹æ‰€','æ‚”ã„ãªã—ï¼ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆ']
  ];

  const timeSets = [
    [{t:'9:00',phase:'am'},{t:'11:30',phase:'mid'},{t:'13:00',phase:'mid'},{t:'15:30',phase:'pm'},{t:'18:00',phase:'pm'}],
    [{t:'8:30',phase:'am'},{t:'10:30',phase:'am'},{t:'13:00',phase:'mid'},{t:'15:00',phase:'mid'},{t:'19:00',phase:'pm'}],
    [{t:'9:30',phase:'am'},{t:'11:00',phase:'mid'},{t:'14:00',phase:'mid'},{t:'16:30',phase:'pm'},{t:'18:30',phase:'pm'}],
  ];

  const days = Array.from({length:numDays},(_,di)=>{
    const td = themeData[di % themeData.length];
    const times = timeSets[di % timeSets.length];
    const ttlArr = dayTitles[di % dayTitles.length];

    const schedule = times.map((slot,si)=>{
      const phase = slot.phase;
      const acts = td[phase] || td.mid;
      const spotList = td.spot || ['ã‚¹ãƒãƒƒãƒˆ'];
      const spot = pickRand(spotList);
      const act = pickRand(acts);
      const theme = themes[si % themes.length];
      const tags = [theme, trans.replace(/^.+ /,''), di===0&&si===0?'åˆæ—¥':di===numDays-1?'æœ€çµ‚æ—¥':''].filter(Boolean).slice(0,2);

      const descs = [
        `${destination}ã®${spot}ã§${act}`,
        `åœ°å…ƒ${spot}ã‚’${theme}ç›®ç·šã§æº€å–«`,
        `${act}ã§${destination}æ°—åˆ†ã‚’å ªèƒ½`,
        `${theme}å¥½ãå¿…è¦‹ã®${spot}ã¸`,
        `${trans}ã§æ¥ãŸã‹ã‚‰ã“ãå¯„ã‚Œã‚‹${spot}`
      ];

      return {
        time: slot.t,
        place: `${destination}ãƒ»${spot}`,
        description: pickRand(descs),
        tags
      };
    });

    return {
      day: numDays===1 ? 'æœ¬æ—¥' : `${di+1}æ—¥ç›®`,
      title: ttlArr,
      schedule
    };
  });

  // Tips
  const tipsByTheme = {
    'ã‚°ãƒ«ãƒ¡':['é£Ÿã¹æ­©ãç”¨ã®è¢‹ã‚’æŒå‚ã—ã‚ˆã†','ãŠè…¹ã‚’ç©ºã‹ã›ã¦ã‹ã‚‰è¡Œãã®ãŒé‰„å‰‡ï¼','åœ°å…ƒã®Bç´šã‚°ãƒ«ãƒ¡ã‚‚å¿˜ã‚Œãšã«'],
    'è‡ªç„¶ãƒ»çµ¶æ™¯':['å‹•ãã‚„ã™ã„ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼ã¯å¿…é ˆ','å¤©æ°—äºˆå ±ã‚’äº‹å‰ã«ãƒã‚§ãƒƒã‚¯','æ—©èµ·ããŒçµ¶æ™¯ã¸ã®è¿‘é“'],
    'ã‚«ãƒ•ã‚§å·¡ã‚Š':['ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼ã‚’å¿˜ã‚Œãšã«','æ··ã‚€å‰ã®é–‹åº—ç›´å¾Œã‚’ç‹™ãŠã†','ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆã‚¹ãƒãƒƒãƒˆã¯ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ãŒç‹™ã„ç›®'],
    'æ­´å²ãƒ»æ–‡åŒ–':['äº‹å‰ã«æ­´å²ã‚’è»½ãèª¿ã¹ã¦ãŠãã¨2å€æ¥½ã—ã„','å¾¡æœ±å°å¸³ã‚’æŒå‚ã—ã‚ˆã†','ã‚¬ã‚¤ãƒ‰ãƒ„ã‚¢ãƒ¼ã‚‚é¸æŠè‚¢ã®ã²ã¨ã¤'],
    'ã‚¤ãƒ³ã‚¹ã‚¿æ˜ ãˆ':['ä¸‰è„šã‹ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’æŒå‚','ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã¯æ—¥ã®å‡ºãƒ»æ—¥æ²¡å‰å¾Œ','è¡£è£…ã‚’ç¾åœ°ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚ˆã†'],
    'æ¸©æ³‰ãƒ»ç™’ã—':['ãƒã‚¹ã‚¿ã‚ªãƒ«ã¨ç€æ›¿ãˆã‚’å¤šã‚ã«','æ—©ã‚æ—©ã‚ã®æ™‚é–“å¸¯ãŒç©ºã„ã¦ã¦ãŠã™ã™ã‚','æ¸©æ³‰æˆåˆ†ã«ã‚ˆã£ã¦ã¯ä¿æ¹¿ã‚¯ãƒªãƒ¼ãƒ ã‚’'],
    'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£':['å‹•ãã‚„ã™ã„æœè£…ã§è¡Œã“ã†','äº‹å‰äºˆç´„ãŒå®‰å¿ƒ','æ€ªæˆ‘é˜²æ­¢ã®ãŸã‚ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’'],
    'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°':['ã‚¨ã‚³ãƒãƒƒã‚°ã‚’æŒå‚ã—ã‚ˆã†','å¸°ã‚Šã®è·ç‰©ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¨ˆç®—ã—ã¦','ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¨ç¾é‡‘ä¸¡æ–¹æº–å‚™'],
    'ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒƒãƒ—ã‚«ãƒ«ãƒãƒ£ãƒ¼':['é™å®šã‚°ãƒƒã‚ºã¯åˆå‰ä¸­ã«ï¼å£²ã‚Šåˆ‡ã‚Œæ³¨æ„','è–åœ°ãƒãƒƒãƒ—ã‚’ã‚¹ãƒãƒ›ã«ä¿å­˜ã—ã¦ãŠã“ã†','ã‚³ã‚¹ãƒ—ãƒ¬OKã‚¹ãƒãƒƒãƒˆã‚’äº‹å‰ã«ç¢ºèª'],
    'å¤œæ™¯ãƒ»ãƒãƒ¼':['å¤œã¯æ°—æ¸©ãŒä¸‹ãŒã‚‹ã®ã§ä¸Šç€ã‚’','ãŠé…’ã¯é£²ã¿éãæ³¨æ„ãƒ»ä»£è¡Œãƒ»é›»è»Šã‚’ç¢ºèª','ã‚«ãƒ¡ãƒ©ã®å¤œæ™¯ãƒ¢ãƒ¼ãƒ‰ã‚’ç·´ç¿’ã—ã¦ãŠã“ã†'],
  };

  const tips = [
    ...(tipsByTheme[themes[0]] || ['è·ç‰©ã¯å¿…è¦æœ€ä½é™ã«','äºˆå‚™ã®ç¾é‡‘ã‚’æŒã£ã¦ãŠã“ã†','æ—…è¡Œä¿é™ºã®åŠ å…¥ã‚’æ¤œè¨ã—ã‚ˆã†']),
    `${trans}ã‚’ä½¿ã£ãŸç§»å‹•ã¯äº‹å‰äºˆç´„ãŒã‚¹ãƒ ãƒ¼ã‚º`,
    'æ—…ã®æ€ã„å‡ºã¯å†™çœŸã ã‘ã§ãªãæ—¥è¨˜ã«ã‚‚æ®‹ãã†'
  ].slice(0,3);

  return {
    destination,
    catchcopy: pickRand(copies),
    emoji: emojis,
    days,
    tips
  };
}

/* ===== SUBMIT ===== */
async function onSubmit(){
  const dep=document.getElementById('f-dep').value.trim();
  const dur=document.getElementById('f-dur').value;
  const themes=[...document.querySelectorAll('.pill.on')].map(p=>p.dataset.v);
  const trans=(document.querySelector('.tp.on')||{}).dataset?.v||'';
  const dest=document.getElementById('f-dest').value.trim();
  const memo=document.getElementById('f-memo').value.trim();

  document.getElementById('errMsg').classList.remove('show');
  if(!dep){showErr('ğŸ“ å‡ºç™ºåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');return;}
  if(!dur){showErr('ğŸ—“ï¸ æ—…ã®æœŸé–“ã‚’é¸ã‚“ã§ãã ã•ã„ï¼');return;}
  if(!themes.length){showErr('ğŸ¨ ãƒ†ãƒ¼ãƒã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ï¼');return;}
  if(!trans){showErr('ğŸš— ç§»å‹•æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ï¼');return;}

  document.getElementById('formCard').style.display='none';
  document.getElementById('loading').classList.add('show');
  startMsgs();

  // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°APIå‘¼ã³å‡ºã—ã€ãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ç”Ÿæˆ
  const hasKey = API_KEY && !API_KEY.includes('xxxxxxxxx') && API_KEY.length > 20;

  if(hasKey){
    await generateWithAPI(dep,dur,themes,trans,dest,memo);
  } else {
    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ©ãƒ³ç”Ÿæˆï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰
    await new Promise(r=>setTimeout(r, 2200)); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¼”å‡º
    const plan = buildPlan(dep,dur,themes,trans,dest,memo);
    stopMsgs();
    document.getElementById('loading').classList.remove('show');
    renderShiori(plan,{dep,dur,themes,trans});
    document.getElementById('shiori').classList.add('show');
  }
}

async function generateWithAPI(dep,dur,themes,trans,dest,memo){
  const prompt=`ã‚ãªãŸã¯æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§æ—…ã®ã—ãŠã‚Šã‚’JSONå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
æ¡ä»¶ï¼šå‡ºç™ºåœ°:${dep} / è¡Œãå…ˆ:${dest||'ãŠã™ã™ã‚ã‚’ææ¡ˆ'} / æœŸé–“:${dur} / ãƒ†ãƒ¼ãƒ:${themes.join('ã€')} / ç§»å‹•:${trans} / ãã®ä»–:${memo||'ãªã—'}
å¿…ãšJSONå½¢å¼ã®ã¿ã§è¿”ç­”ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ä¸è¦ï¼‰ï¼š
{"destination":"ç›®çš„åœ°","catchcopy":"ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼20æ–‡å­—ä»¥å†…","emoji":"çµµæ–‡å­—3ã€œ4å€‹","days":[{"day":"1æ—¥ç›®","title":"ãƒ†ãƒ¼ãƒ","schedule":[{"time":"9:00","place":"å ´æ‰€å","description":"èª¬æ˜30æ–‡å­—","tags":["ã‚¿ã‚°1","ã‚¿ã‚°2"]}]}],"tips":["tip1","tip2","tip3"]}
æœŸé–“ã«å¿œã˜ãŸæ—¥æ•°ã§daysã‚’ä½œæˆã€‚å„æ—¥4ã€œ5å€‹ã®scheduleã€‚`;

  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})
    });
    const data=await res.json();
    const txt=(data.content||[]).map(b=>b.text||'').join('');
    const json=JSON.parse(txt.replace(/```json|```/g,'').trim());
    stopMsgs();
    document.getElementById('loading').classList.remove('show');
    renderShiori(json,{dep,dur:dur,themes,trans});
    document.getElementById('shiori').classList.add('show');
  }catch(e){
    // APIãŒå¤±æ•—ã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã§è£œå®Œ
    const plan = buildPlan(dep,dur,themes,trans,dest,memo);
    stopMsgs();
    document.getElementById('loading').classList.remove('show');
    renderShiori(plan,{dep,dur,themes,trans});
    document.getElementById('shiori').classList.add('show');
  }
}

function showErr(msg){const el=document.getElementById('errMsg');el.textContent=msg;el.classList.add('show');}

function renderShiori(d,meta){
  let html=`<div class="s-cover">
    <div class="s-cover-title">æ—…ã®ã—ãŠã‚Š</div>
    <div class="s-cover-sub">My Travel Notebook</div>
    <div class="s-emoji">${d.emoji||'âœˆï¸ğŸŒŸğŸ—ºï¸'}</div>
    <div class="s-dest">${esc(d.destination)}</div>
    <div class="s-copy">"${esc(d.catchcopy)}"</div>
    <div class="s-badges">
      <span class="badge">ğŸ“ ${esc(meta.dep)}ç™º</span>
      <span class="badge">ğŸ“… ${esc(meta.dur)}</span>
      <span class="badge">${esc(meta.trans)}</span>
    </div>
    <div class="s-badges" style="margin-top:7px;">
      ${meta.themes.map(t=>`<span class="badge theme">${esc(t)}</span>`).join('')}
    </div>
  </div>
  <div class="s-body">`;

  (d.days||[]).forEach((day,di)=>{
    const c=COLORS[di%COLORS.length];
    html+=`<div class="day-block">
      <div class="day-head">
        <span class="day-label" style="background:linear-gradient(135deg,${c.b},${c.b}99)">${esc(day.day)}</span>
        <span class="day-ttl">${esc(day.title)}</span>
      </div>
      <div class="timeline" style="border-left:none">
      <div style="position:absolute;left:6px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,${c.b}80,${c.b}22);border-radius:2px;"></div>`;

    (day.schedule||[]).forEach(item=>{
      html+=`<div class="tl-item">
        <div class="tl-dot" style="background:${c.b}"></div>
        <div class="tl-time" style="color:${c.b}">â° ${esc(item.time)}</div>
        <div class="act-card" style="background:${c.bg};border-left-color:${c.b}">
          <div class="act-name">${esc(item.place)}</div>
          <div class="act-desc">${esc(item.description)}</div>
          ${(item.tags||[]).length?`<div class="act-tags">${item.tags.map(t=>`<span class="act-tag" style="color:${c.b};border-color:${c.b}44;background:${c.bg}">${esc(t)}</span>`).join('')}</div>`:''}
        </div>
      </div>`;
    });
    html+=`</div></div>`;
    if(di<(d.days||[]).length-1) html+=`<div class="divider">âœ¦ âœ¦ âœ¦</div>`;
  });

  if((d.tips||[]).length){
    html+=`<div class="tips-box"><div class="tips-title">ğŸ’¡ æ—…ã®ãƒ’ãƒ³ãƒˆãƒ»æŒã¡ç‰©ãƒã‚§ãƒƒã‚¯</div>${d.tips.map(t=>`<div class="tip-row">â€¢ ${esc(t)}</div>`).join('')}</div>`;
  }
  html+=`<div class="s-footer">âœˆï¸ ğŸŒŸ è‰¯ã„æ—…ã‚’ï¼ ğŸŒŸ âœˆï¸</div><div class="s-credit">created by tabisora</div></div>`;
  document.getElementById('shioriContent').innerHTML=html;
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function goBack(){
  document.getElementById('shiori').classList.remove('show');
  document.getElementById('shioriContent').innerHTML='';
  document.getElementById('formCard').style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
